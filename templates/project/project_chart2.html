{% extends "base_wide.html" %}

{% block child_css %}
<!-- <script src="https://code.highcharts.com/highcharts.js"></script> -->
<script src="https://code.highcharts.com/gantt/highcharts-gantt.js"></script>
<script src="https://code.highcharts.com/gantt/modules/exporting.js"></script>
<script src="https://code.highcharts.com/gantt/modules/accessibility.js"></script>
<!-- <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script> -->
<!-- <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script> -->
{% endblock %}

{% block content %}
<div id="container"></div>
<!-- <div id="content_root" class="container-fluid mt-1"></div>   -->
<!-- container-float margin top 3 -->
{% endblock content %}

{% block child_js_above_files %} 
<script>
    let tDefaultOptions = {
        title: {
            text: 'Projects'
        },

        xAxis: {
            currentDateIndicator: true,
        },

        yAxis: {
            uniqueNames: true
        },

        navigator: {
            enabled: true,
            liveRedraw: true,
            series: {
                type: 'gantt',
                pointPlacement: 0.5,
                pointPadding: 0.25,
                accessibility: {
                    enabled: false
                }
            },
            yAxis: {
                min: 0,
                max: 3,
                reversed: true,
                categories: []
            }
        },

        scrollbar: {
            enabled: true
        },

        rangeSelector: {
            enabled: true,
            selected: 0
        },

        accessibility: {
            point: {
                descriptionFormatter: function (point) {
                    var completedValue = point.completed ?
                            point.completed.amount || point.completed : null,
                        completed = completedValue ?
                            ' Task ' + Math.round(completedValue * 1000) / 10 + '% completed.' :
                            '';
                    return Highcharts.format(
                        '{point.yCategory}.{completed} Start {point.x:%Y-%m-%d}, end {point.x2:%Y-%m-%d}.',
                        { point, completed }
                    );
                }
            },
            series: {
                descriptionFormatter: function (series) {
                    return series.name;
                }
            }
        },

        lang: {
            accessibility: {
                axis: {
                    xAxisDescriptionPlural: 'The chart has a two-part X axis showing time in both week numbers and days.',
                    yAxisDescriptionPlural: 'The chart has one Y axis showing task categories.'
                }
            }
        },

        series: []
    };
    
    let tChart = Highcharts.ganttChart('container', Object.assign({}, tDefaultOptions));
    function convertDate(pYYYYMMDD) {
        let tData = pYYYYMMDD.split("-");
        return Date.UTC(Number.parseInt(tData[0]), Number.parseInt(tData[1]) - 1, Number.parseInt(tData[2]));
    }

    fetch("/api/1.0/projects")
    .then(response => response.json())
    .then((res)=>{
        let tList = [];
        let tMinTime = Date.now(), tMaxTime = Date.now();
        // let tList = res.map((pItem) => { return {start: convertDate(pItem.p_pre_plan_b), end: convertDate(pItem.p_close), completed: pItem.progress / 100, name: pItem.title}; });
        res.forEach((pItem) => {
            let tStart = convertDate(pItem.p_pre_plan_b);
            let tEnd = convertDate(pItem.p_close);
            tMinTime = Math.min(tMinTime, new Date(tStart).getTime());
            tMaxTime = Math.max(tMaxTime, new Date(tEnd).getTime());
            tList.push({start: tStart, end: tEnd, completed: (pItem.progress / 100), name: pItem.title});
        });
        tChart = Highcharts.ganttChart('container', Object.assign({}, tDefaultOptions, {series: [{ name: '', data: tList }]}));
        tChart.xAxis[0].setExtremes(tMinTime, tMaxTime);
        console.log(tChart);
    });
</script>
{% endblock %}
